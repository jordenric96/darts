<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yarni's Darts Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Theme Variables */
            --bg-gradient: linear-gradient(135deg, #b721ff 0%, #21d4fd 100%);
            --glass-bg: rgba(20, 20, 20, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --text-color: #ffffff;
            --accent: #00e676; 
            --danger: #ff1744;
            --highlight: #21d4fd;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        h1, h2 { text-align: center; margin: 5px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }
        
        .logo { 
            font-size: 1.8rem; 
            font-weight: 800; 
            border-bottom: 3px solid white; 
            margin-bottom: 20px; 
            padding-bottom: 5px; 
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .container { width: 100%; max-width: 600px; padding-bottom: 60px; }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
        }

        /* BUTTONS */
        button {
            border: none; border-radius: 12px; padding: 15px;
            font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1rem;
            cursor: pointer; width: 100%; margin-bottom: 10px;
            transition: transform 0.1s;
            background: rgba(255, 255, 255, 0.1); color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        button:active { transform: scale(0.96); }
        
        .btn-primary { background: var(--highlight); color: #000; border: none; }
        .btn-success { background: var(--accent); color: #000; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-gold { background: var(--gold); color: #000; border: none; }
        
        /* INPUTS */
        input[type="text"], input[type="number"] {
            width: 100%; padding: 15px; border-radius: 10px;
            border: none; background: rgba(255,255,255,0.9);
            margin-bottom: 10px; font-size: 1rem;
        }

        /* SCOREBOARD */
        .scoreboard {
            display: flex; justify-content: center; gap: 8px;
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .p-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 10px;
            min-width: 90px; text-align: center;
            opacity: 0.6; transform: scale(0.95); transition: 0.3s;
        }
        .p-card.active-turn {
            background: rgba(33, 212, 253, 0.15);
            border: 2px solid var(--highlight);
            box-shadow: 0 0 25px rgba(33, 212, 253, 0.6);
            opacity: 1; transform: scale(1.05); z-index: 10;
        }
        .p-name { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; }
        .p-score { font-size: 2.5rem; font-weight: 800; color: white; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .p-avg { font-size: 0.8rem; color: var(--accent); }

        /* DISPLAYS & KEYPADS */
        .score-display-box {
            background: black; color: var(--accent);
            font-family: 'Courier New', monospace;
            font-size: 3rem; font-weight: bold;
            padding: 10px; text-align: center;
            border-radius: 10px; margin-bottom: 15px;
            border: 2px solid #333;
        }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .keypad button { padding: 20px; font-size: 1.4rem; background: rgba(255,255,255,0.1); margin: 0; }

        /* GAME SPECIFIC */
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .input-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        
        .big-icon { font-size: 4rem; display: block; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.3); }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--highlight); padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* UTILS */
        .screen { display: none; }
        .active { display: block; }
        .player-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 8px; }
        .player-select-checkbox { width: 25px; height: 25px; accent-color: var(--accent); }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    </style>
</head>
<body>

    <div class="logo">üöÄ Yarni's Darts Arcade</div>

    <div class="container">

        <div id="screen-players" class="screen active card">
            <h2>Wie speelt er mee?</h2>
            <div style="display:flex; gap:5px;">
                <input type="text" id="new-player-name" placeholder="Naam...">
                <button onclick="addPlayer()" style="width: auto; background: var(--accent);">+</button>
            </div>
            <div id="player-list" style="max-height: 250px; overflow-y: auto; margin: 15px 0;"></div>
            <button class="btn-primary" onclick="confirmPlayers()">Naar Spelkeuze ‚ûî</button>
        </div>

        <div id="screen-menu" class="screen card">
            <h2>Kies een spel</h2>
            <p style="text-align:center; opacity:0.7; font-size:0.9rem" id="active-players-display"></p>
            
            <button onclick="setupDoubles()">Doubles (Clock)</button>
            <button onclick="setupSingles()">Singles (Random 1-20)</button>
            <button onclick="setupX01()">X01 (301 / 501)</button>
            <button onclick="setupCheckoutMenu()">Checkout Challenge (6p)</button>
            <button onclick="setup100Menu()" class="btn-gold">100 Pijlen Challenge</button>
            <button onclick="setupBullstreak()">Bullstreak (Beurten)</button>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:20px 0;">
            <button onclick="showStats()">üìä Statistieken</button>
            <button onclick="showScreen('screen-players')" style="background:transparent; border:1px solid rgba(255,255,255,0.3);">Terug</button>
        </div>

        <div id="screen-game-doubles" class="screen card">
            <div id="doubles-scoreboard" class="scoreboard"></div>
            <p style="text-align:center; opacity:0.8;">Pijlen verbruikt: <strong id="doubles-darts-count">0</strong></p>
            <div class="input-grid">
                <button class="btn-success" onclick="handleDoublesInput(1)">1e Pijl</button>
                <button class="btn-success" onclick="handleDoublesInput(2)">2e Pijl</button>
                <button class="btn-success" onclick="handleDoublesInput(3)">3e Pijl</button>
            </div>
            <button class="btn-danger" onclick="handleDoublesMiss()">Alles Gemist (0)</button>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-game-singles" class="screen card">
            <div id="singles-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; margin-bottom:10px;">Hits (3 pijlen)?</div>
            <div class="input-grid-4">
                <button class="btn-danger" onclick="handleSinglesInput(0)">0</button>
                <button class="btn-success" onclick="handleSinglesInput(1)">1</button>
                <button class="btn-success" onclick="handleSinglesInput(2)">2</button>
                <button class="btn-success" onclick="handleSinglesInput(3)">3</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-checkout-setup" class="screen card">
            <h2>Checkout Setup</h2>
            <label>Getal tussen:</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="co-min" value="60">
                <input type="number" id="co-max" value="100">
            </div>
            <button class="btn-primary" onclick="startCheckoutGame()">Start Challenge</button>
            <button onclick="showScreen('screen-menu')" style="background:transparent;">Annuleren</button>
        </div>
        <div id="screen-game-checkout" class="screen card">
            <div id="checkout-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; margin-bottom:5px; color:#aaa;">Ronde <span id="co-round">1</span>/10 | Beurt <span id="co-turn">1</span>/2</div>
            <div style="text-align:center; font-size:4rem; font-weight:800; color:var(--highlight); text-shadow:0 0 20px rgba(33,212,253,0.5);" id="co-target">?</div>
            <div id="checkout-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--danger)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submitCheckout()" class="btn-success">OK</button>
            </div>
            <div id="checkout-history-container" style="display:flex; justify-content:center; gap:5px; margin-top:10px;"></div>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-game-x01" class="screen card">
            <div id="x01-scoreboard" class="scoreboard"></div>
            <div id="x01-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--danger)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submitX01()" class="btn-success">OK</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-100-setup" class="screen card">
            <h2>100 Pijlen Mode</h2>
            <button onclick="start100Game('high')">üîº Hoogste Score</button>
            <button onclick="start100Game('low')">üîΩ Laagste Score</button>
            <button onclick="showScreen('screen-menu')" style="background:transparent;">Terug</button>
        </div>
        <div id="screen-game-100" class="screen card">
            <div id="100-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; font-size:1.2rem; margin-bottom:10px;">Pijlen: <span id="100-counter" style="color:var(--highlight); font-weight:bold;">0</span>/100</div>
            <div id="100-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--danger)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submit100()" class="btn-success">OK</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-game-bullstreak" class="screen card">
            <div id="bull-scoreboard" class="scoreboard"></div>
            
            <div style="text-align:center; margin-top:20px;">
                <div style="font-size:0.9rem; opacity:0.8;">HUIDIGE STREAK (Beurten)</div>
                <div id="bull-streak-val" style="font-size:6rem; font-weight:800; color:var(--gold); text-shadow:0 0 30px rgba(255,215,0,0.5);">0</div>
            </div>

            <div style="text-align:center; margin:20px 0;">
                <p>Gooi 3 pijlen. Minstens 1 Bull?</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <button class="btn-success" style="height:100px; font-size:1.5rem;" onclick="handleBullResult(true)">‚úÖ RAAK</button>
                    <button class="btn-danger" style="height:100px; font-size:1.5rem;" onclick="handleBullResult(false)">‚ùå MIS</button>
                </div>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:rgba(0,0,0,0.3);">Stoppen</button>
        </div>

        <div id="screen-stats" class="screen card">
            <h2>Statistieken</h2>
            <select id="stats-player-select" onchange="renderStats()" style="width:100%; padding:10px; border-radius:10px; margin-bottom:15px; background:white; color:black;"></select>
            
            <div id="stats-content">
                </div>
            <button onclick="showScreen('screen-menu')" style="margin-top:20px;">Terug</button>
        </div>

    </div>

    <script>
        // --- DATA ---
        let allPlayers = JSON.parse(localStorage.getItem('dartsPlayers')) || [];
        // Structure V3: { date, gameType ('doubles','x01','100high','100low','bullstreak'), player, result (score, count, or obj) }
        let history = JSON.parse(localStorage.getItem('dartsHistoryV3')) || [];
        
        let activePlayers = [];
        let curPIdx = 0;
        let gameMode = ''; 
        
        // GAME STATES
        let doublesState = {}, singlesState = {}, x01State = {}, checkoutState = {};
        let state100 = {}, stateBull = {};

        // Helper Vars
        const boardOrder = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5, 25];
        let keypadInput = "";

        // --- KEYBOARD ---
        document.addEventListener('keydown', e => {
            const k = e.key;
            // Detect Active Screen for Keypad
            if (document.querySelector('.screen.active .keypad')) {
                if (!isNaN(k) && k !== ' ') kp(parseInt(k));
                else if (k === 'Backspace') kp('BACK');
                else if (k === 'Enter') {
                    if (gameMode==='x01') submitX01();
                    if (gameMode==='checkout') submitCheckout();
                    if (gameMode==='100') submit100();
                }
            }
        });

        // --- PLAYER MGT ---
        function renderPlayerList() {
            const l = document.getElementById('player-list'); l.innerHTML = '';
            if(!allPlayers.length) l.innerHTML = '<p style="text-align:center;opacity:0.5">Geen spelers</p>';
            allPlayers.forEach(n => {
                l.innerHTML += `<div class="player-row"><span>${n}</span><input type="checkbox" class="cb" value="${n}"></div>`;
            });
        }
        function addPlayer() {
            const n = document.getElementById('new-player-name').value.trim();
            if(n && !allPlayers.includes(n)) { allPlayers.push(n); localStorage.setItem('dartsPlayers',JSON.stringify(allPlayers)); renderPlayerList(); }
            document.getElementById('new-player-name').value = '';
        }
        function confirmPlayers() {
            activePlayers = Array.from(document.querySelectorAll('.cb:checked')).map(c=>c.value);
            if(!activePlayers.length) return alert("Kies speler(s)");
            document.getElementById('active-players-display').innerText = activePlayers.join(", ");
            showScreen('screen-menu');
        }

        // --- NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-players') renderPlayerList();
        }
        function quitGame() { if(confirm("Stoppen?")) showScreen('screen-menu'); }

        // --- COMMON LOGIC ---
        function nextTurn() { curPIdx = (curPIdx + 1) % activePlayers.length; }
        function saveRec(type, player, res) {
            history.push({ date: new Date().toISOString(), gameType: type, player: player, result: res });
            localStorage.setItem('dartsHistoryV3', JSON.stringify(history));
        }
        function kp(v) {
            if (v==='BACK') keypadInput = keypadInput.slice(0,-1);
            else if (keypadInput.length < 3) keypadInput += v;
            updateDisplay();
        }
        function updateDisplay() {
            const els = ['x01-display','checkout-display','100-display'];
            els.forEach(id => { 
                const el = document.getElementById(id); 
                if(el && document.getElementById(id).closest('.screen').classList.contains('active')) el.innerText = keypadInput || "0"; 
            });
        }

        // --- GAME: DOUBLES ---
        function setupDoubles() {
            gameMode = 'doubles'; doublesState = {};
            activePlayers.forEach(p => doublesState[p] = { idx: 0, curDarts: 0, totDarts: 0, hits: 0 });
            curPIdx = 0; updateDoublesUI(); showScreen('screen-game-doubles');
        }
        function updateDoublesUI() {
            const sb = document.getElementById('doubles-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((p,i) => {
                const s = doublesState[p];
                const fin = s.idx >= boardOrder.length;
                const txt = fin ? "WIN" : (boardOrder[s.idx]===25?"BULL":"D"+boardOrder[s.idx]);
                const avg = s.hits>0 ? (s.totDarts/s.hits).toFixed(1) : "-";
                sb.innerHTML += `<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${txt}</div><div class="p-avg">Gem: ${avg}</div></div>`;
            });
            document.getElementById('doubles-darts-count').innerText = doublesState[activePlayers[curPIdx]].curDarts;
        }
        function handleDoublesInput(d) {
            const p = activePlayers[curPIdx], s = doublesState[p];
            s.totDarts += (s.curDarts + d); s.hits++;
            saveRec('doubles', p, { target: boardOrder[s.idx], darts: s.curDarts+d });
            s.idx++; s.curDarts = 0;
            if(s.idx >= boardOrder.length) { alert(p + " WINT!"); showScreen('screen-menu'); return; }
            nextTurn(); updateDoublesUI();
        }
        function handleDoublesMiss() {
            const p = activePlayers[curPIdx]; doublesState[p].curDarts += 3; doublesState[p].totDarts += 3;
            nextTurn(); updateDoublesUI();
        }

        // --- GAME: SINGLES ---
        function setupSingles() {
            gameMode = 'singles'; singlesState = {};
            const list = [...Array(20).keys()].map(i=>i+1); list.push(25);
            activePlayers.forEach(p => singlesState[p] = { q: list.sort(()=>Math.random()-0.5), idx: 0, score: 0 });
            curPIdx = 0; updateSinglesUI(); showScreen('screen-game-singles');
        }
        function updateSinglesUI() {
            const sb = document.getElementById('singles-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((p,i) => {
                const s = singlesState[p];
                if(s.idx>=s.q.length) { sb.innerHTML+=`<div class="p-card"><div class="p-name">${p}</div><div class="p-score">FIN</div></div>`; return; }
                const v = s.q[s.idx], t = v===25?"BULL":v;
                sb.innerHTML += `<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${t}</div><div class="p-avg">Hits: ${s.score}</div></div>`;
            });
            if(singlesState[activePlayers[curPIdx]].idx >= singlesState[activePlayers[curPIdx]].q.length) { alert("Klaar!"); showScreen('screen-menu'); }
        }
        function handleSinglesInput(h) {
            const p = activePlayers[curPIdx]; singlesState[p].score += h; singlesState[p].idx++;
            nextTurn(); updateSinglesUI();
        }

        // --- GAME: X01 ---
        function setupX01() {
            const start = prompt("301 of 501?", "501") === "301" ? 301 : 501;
            gameMode = 'x01'; x01State = {}; keypadInput = "";
            activePlayers.forEach(p => x01State[p] = { score: start, start: start, darts: 0 });
            curPIdx = 0; updateX01UI(); showScreen('screen-game-x01');
        }
        function updateX01UI() {
            const sb = document.getElementById('x01-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((p,i) => {
                const s = x01State[p];
                const avg = s.darts>0 ? ((s.start-s.score)/(s.darts/3)).toFixed(1) : "-";
                sb.innerHTML += `<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${s.score}</div><div class="p-avg">Gem: ${avg}</div></div>`;
            });
            updateDisplay();
        }
        function submitX01() {
            const v = parseInt(keypadInput);
            if(isNaN(v) || v > 180) return alert("Ongeldig");
            const p = activePlayers[curPIdx], s = x01State[p], n = s.score - v;
            if (n === 0) { alert(p + " WINT!"); showScreen('screen-menu'); return; }
            if (n > 1) s.score = n; else alert("BUST");
            s.darts += 3; keypadInput = ""; nextTurn(); updateX01UI();
        }

        // --- GAME: CHECKOUT ---
        function setupCheckoutMenu() { showScreen('screen-checkout-setup'); }
        function startCheckoutGame() {
            const min = parseInt(document.getElementById('co-min').value), max = parseInt(document.getElementById('co-max').value);
            gameMode = 'checkout'; checkoutState = {}; keypadInput = "";
            activePlayers.forEach(p => checkoutState[p] = { r:1, hist:[], tStart: rInt(min,max), cur:0, turns:0, min:min, max:max });
            activePlayers.forEach(p => checkoutState[p].cur = checkoutState[p].tStart);
            curPIdx = 0; updateCheckoutUI(); showScreen('screen-game-checkout');
        }
        function updateCheckoutUI() {
            const p = activePlayers[curPIdx], s = checkoutState[p];
            if(s.r > 10) { alert("Klaar!"); showScreen('screen-menu'); return; }
            
            // Scoreboard
            const sb = document.getElementById('checkout-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((pl,i) => {
                const w = checkoutState[pl].hist.filter(x=>x).length;
                sb.innerHTML += `<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${pl}</div><div class="p-score" style="font-size:1.5rem">${w}/10</div></div>`;
            });

            document.getElementById('co-round').innerText = s.r; document.getElementById('co-turn').innerText = s.turns+1;
            document.getElementById('co-target').innerText = s.cur;
            
            const hc = document.getElementById('checkout-history-container'); hc.innerHTML = '';
            s.hist.forEach(h => hc.innerHTML += `<span style="font-size:1.5rem;background:#333;padding:5px;border-radius:5px;">${h?"üéØ":"ü§°"}</span>`);
            updateDisplay();
        }
        function submitCheckout() {
            const v = parseInt(keypadInput); if(isNaN(v) || v > 180) return;
            const p = activePlayers[curPIdx], s = checkoutState[p];
            const n = s.cur - v;
            
            if (n === 0) { // Success
                alert("UIT!"); s.hist.push(true); nextRoundCO(s);
            } else if (n <= 1) { // Bust
                alert("BUST"); s.turns++; checkFailCO(s);
            } else { // Continue
                s.cur = n; s.turns++; checkFailCO(s);
            }
            keypadInput = ""; 
            if(s.cur > 0) nextTurn(); // Wissel speler als niet uitgegooid
            updateCheckoutUI();
        }
        function checkFailCO(s) { if(s.turns >= 2 && s.cur > 0) { alert("Beurten op!"); s.hist.push(false); nextRoundCO(s); } }
        function nextRoundCO(s) { s.r++; s.turns=0; s.tStart = rInt(s.min, s.max); s.cur = s.tStart; }

        // --- GAME: 100 PIJLEN ---
        let mode100 = 'high'; // 'high' or 'low'
        function setup100Menu() { showScreen('screen-100-setup'); }
        function start100Game(mode) {
            mode100 = mode; gameMode = '100'; state100 = {}; keypadInput = "";
            activePlayers.forEach(p => state100[p] = { score: 0, dartsThrown: 0 });
            curPIdx = 0; update100UI(); showScreen('screen-game-100');
        }
        function update100UI() {
            const sb = document.getElementById('100-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((p,i) => {
                const s = state100[p];
                sb.innerHTML += `<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${s.score}</div><div class="p-avg">${mode100==='high'?'Hoog':'Laag'}</div></div>`;
            });
            document.getElementById('100-counter').innerText = state100[activePlayers[curPIdx]].dartsThrown;
            updateDisplay();
        }
        function submit100() {
            const v = parseInt(keypadInput);
            const p = activePlayers[curPIdx], s = state100[p];
            const dartsLeft = 100 - s.dartsThrown;
            
            // Logic for last dart (single dart input) vs normal (3 darts)
            let dartsThisTurn = 3;
            let maxScore = 180;

            if (dartsLeft === 1) {
                dartsThisTurn = 1;
                maxScore = 60; // Max single dart score is T20
                if (v > 60) return alert("Max 60 voor 1 pijl!");
            } else if (isNaN(v) || v > 180) return alert("Ongeldig");

            s.score += v;
            s.dartsThrown += dartsThisTurn;
            keypadInput = "";

            if (s.dartsThrown >= 100) {
                alert(`${p} Klaar! Eindscore: ${s.score}`);
                saveRec(mode100 === 'high' ? '100high' : '100low', p, s.score);
                // Mark finished logic conceptually needed if multiplayer, but simple alert + reset for now
                if(curPIdx === activePlayers.length -1) {
                    showScreen('screen-menu'); return;
                }
            }
            
            nextTurn(); update100UI();
        }

        // --- GAME: BULLSTREAK ---
        function setupBullstreak() {
            gameMode = 'bull'; stateBull = {};
            activePlayers.forEach(p => stateBull[p] = { streak: 0, best: 0, alive: true });
            curPIdx = 0; updateBullUI(); showScreen('screen-game-bullstreak');
        }
        function updateBullUI() {
            // Find next alive player
            let attempts = 0;
            while(!stateBull[activePlayers[curPIdx]].alive && attempts < activePlayers.length) {
                curPIdx = (curPIdx + 1) % activePlayers.length;
                attempts++;
            }
            if(attempts >= activePlayers.length) { alert("Iedereen af!"); showScreen('screen-menu'); return; }

            const sb = document.getElementById('bull-scoreboard'); sb.innerHTML = '';
            activePlayers.forEach((p,i) => {
                const s = stateBull[p];
                const cls = !s.alive ? 'opacity:0.3' : (i===curPIdx?'background:var(--highlight);color:black':'');
                sb.innerHTML += `<div class="p-card" style="${cls}"><div class="p-name">${p}</div><div class="p-score" style="font-size:1.5rem">${s.streak}</div></div>`;
            });
            
            document.getElementById('bull-streak-val').innerText = stateBull[activePlayers[curPIdx]].streak;
        }
        function handleBullResult(hit) {
            const p = activePlayers[curPIdx], s = stateBull[p];
            if(hit) {
                s.streak++;
                if(s.streak > s.best) s.best = s.streak;
            } else {
                alert(`Helaas! Streak: ${s.streak}`);
                saveRec('bullstreak', p, s.streak);
                s.alive = false;
            }
            curPIdx = (curPIdx + 1) % activePlayers.length;
            updateBullUI();
        }

        // --- STATS ---
        function showStats() {
            const s = document.getElementById('stats-player-select'); s.innerHTML = '<option value="">-- Kies --</option>';
            allPlayers.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('stats-content').innerHTML = '';
            showScreen('screen-stats');
        }
        function renderStats() {
            const p = document.getElementById('stats-player-select').value;
            if(!p) return;
            const c = document.getElementById('stats-content'); c.innerHTML = '';
            const recs = history.filter(h => h.player === p);

            // Helper to find best
            const getBest = (type, mode='max') => {
                const rs = recs.filter(r => r.gameType === type).map(r => parseInt(r.result.score || r.result));
                if(!rs.length) return '-';
                return mode==='max' ? Math.max(...rs) : Math.min(...rs);
            };

            // 1. Records Card
            let html = `
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-bottom:15px;">
                <h3 style="color:var(--gold); margin-top:0;">üèÜ Persoonlijke Records</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
                    <div><div style="font-size:0.8rem">100 Pijlen (Hoog)</div><div style="font-size:1.5rem; font-weight:bold;">${getBest('100high')}</div></div>
                    <div><div style="font-size:0.8rem">100 Pijlen (Laag)</div><div style="font-size:1.5rem; font-weight:bold;">${getBest('100low', 'min')}</div></div>
                    <div style="grid-column:span 2; border-top:1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:5px;">
                        <div style="font-size:0.8rem">Langste Bullstreak (Beurten)</div><div style="font-size:2rem; color:var(--accent); font-weight:bold;">${getBest('bullstreak')}</div>
                    </div>
                </div>
            </div>`;

            // 2. Doubles Table
            html += `<h3 style="color:var(--highlight)">Doubles Gemiddelden</h3>
            <div style="max-height:250px; overflow-y:auto;"><table id="stats-table"><thead><tr><th>Doel</th><th>Gem.</th><th>Hits</th></tr></thead><tbody>`;
            
            // Calc doubles logic (same as before)
            let totals = {};
            // Filter oude data structuur (als die er nog is) en nieuwe 'doubles' type
            const doubleRecs = recs.filter(r => r.gameType === 'doubles' || (!r.gameType && r.target)); 
            doubleRecs.forEach(i => {
                const t = i.result ? i.result.target : i.target; // support V2/V3
                const d = i.result ? i.result.darts : i.darts;
                if(!totals[t]) totals[t] = {sum:0, c:0};
                totals[t].sum += d; totals[t].c++;
            });
            boardOrder.forEach(n => {
                const l = n===25?"Bull":"D"+n;
                const s = totals[n];
                let avg="-", h=0, col="";
                if(s) { h=s.c; const v=s.sum/h; avg=v.toFixed(1); if(v<=3) col="color:var(--accent)"; else if(v>=9) col="color:var(--danger)"; }
                html += `<tr><td>${l}</td><td style="${col}">${avg}</td><td>${h}</td></tr>`;
            });
            html += `</tbody></table></div>`;

            c.innerHTML = html;
        }

        function rInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        renderPlayerList();
    </script>
</body>
</html>
