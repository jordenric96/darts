<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Darten Jorden: Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* THEMA: Darten Jorden (Rocket Style) */
            --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --glass-bg: rgba(20, 20, 30, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            
            --c-cyan: #00f3ff;
            --c-pink: #ff00aa;
            --c-yellow: #ffee00;
            --c-red: #ff3b3b;
            --c-green: #00e676;
            
            --text-color: #ffffff;
            --btn-bg: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            overflow-x: hidden;
        }

        h1, h2, h3 { text-align: center; text-transform: uppercase; letter-spacing: 1px; margin: 10px 0; }
        
        .logo { 
            font-size: 2.2rem; font-weight: 900; font-style: italic;
            background: -webkit-linear-gradient(0deg, var(--c-yellow), var(--c-pink), var(--c-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 25px; text-shadow: 0 0 30px rgba(255,0,170,0.3);
            cursor: pointer;
        }

        .container { width: 100%; max-width: 800px; padding-bottom: 80px; }

        .card {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            border: var(--glass-border); border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); margin-bottom: 20px;
            animation: slideUp 0.4s ease-out;
            position: relative;
        }

        /* UNDO BUTTON */
        .btn-undo {
            position: absolute; top: 15px; left: 15px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--c-yellow); color: black;
            border: none; font-size: 1.2rem; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(255,238,0,0.5);
            z-index: 10; padding: 0; margin: 0;
        }
        .btn-undo:active { transform: scale(0.9); }

        /* KNOPPEN */
        button {
            border: none; border-radius: 15px; padding: 15px 25px;
            font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1rem;
            cursor: pointer; width: 100%; margin-bottom: 12px;
            transition: all 0.1s ease; background: var(--btn-bg); color: white;
            border: 1px solid rgba(255,255,255,0.05); text-transform: uppercase; letter-spacing: 1px;
            user-select: none; touch-action: manipulation;
        }
        button:active { transform: scale(0.95); filter: brightness(1.2); }
        
        .btn-cyan { background: linear-gradient(90deg, #00f3ff, #0099ff); color: #000; border:none; box-shadow: 0 4px 15px rgba(0, 243, 255, 0.3); }
        .btn-pink { background: linear-gradient(90deg, #ff00aa, #ff4d4d); color: #fff; border:none; box-shadow: 0 4px 15px rgba(255, 0, 170, 0.3); }
        .btn-yellow { background: linear-gradient(90deg, #ffee00, #ffaa00); color: #000; border:none; box-shadow: 0 4px 15px rgba(255, 238, 0, 0.3); }
        .btn-purple { background: linear-gradient(90deg, #bc13fe, #7a00ff); color: #fff; border:none; box-shadow: 0 4px 15px rgba(188, 19, 254, 0.3); }
        .btn-green { background: linear-gradient(90deg, #00e676, #00c853); color: #000; border:none; }
        
        .btn-delete {
            background: rgba(255, 59, 59, 0.2); color: var(--c-red); width: 40px; height: 40px; padding: 0;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin: 0; border: 1px solid var(--c-red);
        }

        .btn-chart-toggle { width: auto; display: inline-block; padding: 8px 16px; font-size: 0.8rem; margin: 0 5px 5px 0; border-radius: 8px; }
        .btn-chart-toggle.active-chart { background: white; color: black; box-shadow: 0 0 15px white; }

        /* INPUTS */
        input {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #333; background: black;
            color: var(--c-cyan); margin-bottom: 10px; font-size: 1.5rem; text-align: center;
            font-family: 'Courier New', monospace; font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0, 243, 255, 0.2); text-transform: uppercase;
        }
        input:focus { border-color: var(--c-cyan); outline: none; box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

        /* UI ELEMENTS */
        .player-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 8px; }
        .player-select-checkbox { width: 25px; height: 25px; accent-color: var(--c-pink); margin-right: 15px; cursor: pointer; }
        
        .scoreboard { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .p-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; min-width: 100px; text-align: center; transition: 0.3s; }
        .p-card.active-turn { background: rgba(0, 243, 255, 0.1); border: 2px solid var(--c-cyan); transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 243, 255, 0.4); }
        .p-name { font-size: 0.8rem; font-weight: 700; color: #aaa; margin-bottom: 5px; }
        .p-score { font-size: 2.2rem; font-weight: 900; color: white; line-height: 1; }
        .leg-indicator { font-size: 0.8rem; color: var(--c-yellow); margin-top: 5px; font-weight: bold; }
        
        .score-display-box { background: black; color: var(--c-yellow); font-family: 'Courier New', monospace; font-size: 3.5rem; font-weight: bold; padding: 15px; text-align: center; border-radius: 15px; margin-bottom: 20px; border: 2px solid #333; box-shadow: inset 0 0 20px rgba(255,238,0,0.2); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .keypad button { padding: 20px; font-size: 1.5rem; background: rgba(255,255,255,0.05); margin: 0; border-radius: 15px; }
        .keypad button:active { background: var(--c-cyan); color: black; }

        /* INSTRUCTIE TEXT */
        .instruction-text {
            text-align: center; color: var(--c-cyan); font-size: 0.9rem;
            margin-bottom: 15px; font-style: italic; font-weight: bold;
            background: rgba(0, 243, 255, 0.1); padding: 8px; border-radius: 10px;
            border: 1px dashed rgba(0, 243, 255, 0.3); margin-top: 25px;
        }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: linear-gradient(135deg, #2a2a40 0%, #1a1a2e 100%); border: 2px solid var(--c-cyan); border-radius: 20px; padding: 30px; width: 95%; max-width: 450px; text-align: center; box-shadow: 0 0 50px rgba(0, 243, 255, 0.3); transform: scale(0.8); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .option-btn { height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.2rem; }
        .option-icon { font-size: 2.5rem; margin-bottom: 10px; }

        /* SUMMARY DASHBOARD */
        .summary-score { font-size: 4rem; font-weight: 900; color: white; text-shadow: 0 0 20px var(--c-cyan); margin: 10px 0; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .summary-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        .sb-label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .sb-val { font-size: 1.2rem; font-weight: bold; color: white; }
        
        .screen { display: none; } .active { display: block; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; background: rgba(0,0,0,0.3); }
        
        @keyframes slideUp { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
        @keyframes flashRed { 0% { background-color: rgba(255,0,0,0.5); } 100% { background-color: var(--glass-bg); } }
        .flash-red { animation: flashRed 0.5s; }
    </style>
</head>
<body>

    <div class="logo" onclick="sfx.win()">üöÄ Darts Jorden</div>

    <div class="container">

        <div id="screen-players" class="screen active card">
            <h2>Wie speelt er mee?</h2>
            <div style="display:flex; gap:10px; margin-bottom: 15px; align-items: center;">
                <input type="text" id="new-player-name" placeholder="NAAM" autocomplete="off" style="margin:0;">
                <button onclick="handleAddPlayer()" class="btn-cyan" style="width: auto; margin:0; padding: 15px 20px; font-size:1.5rem;">+</button>
            </div>
            <div id="player-list"></div>
            <br>
            <button class="btn-pink" onclick="confirmPlayers()">üöÄ Start Game</button>
        </div>

        <div id="screen-menu" class="screen card">
            <h2>Kies je Challenge</h2>
            <p id="active-players-display" style="text-align:center; opacity:0.7; margin-bottom: 20px;"></p>
            
            <button onclick="openGameMenu('doubles', 'Doubles (Clock)', desc.doubles)" class="btn-cyan">Doubles (Clock)</button>
            <button onclick="openGameMenu('singles', 'Singles (Random)', desc.singles)" class="btn-cyan">Singles (Random)</button>
            <button onclick="openGameMenu('bobs27', 'Bob\'s 27', desc.bobs)" class="btn-yellow">Bob's 27</button>
            <button onclick="openGameMenu('x01', 'X01 Wedstrijd', desc.x01)" class="btn-purple">X01 Wedstrijd</button>
            <button onclick="openGameMenu('checkout', 'Checkout Challenge', desc.checkout)" class="btn-purple">Checkout Challenge</button>
            <button onclick="openGameMenu('100', '100 Pijlen', desc.p100)" class="btn-yellow">100 Pijlen</button>
            <button onclick="openGameMenu('bull', 'Bullstreak', desc.bull)" class="btn-pink">Bullstreak</button>
            
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 25px 0;"></div>
            
            <button onclick="showRecords()" style="background: transparent; border: 1px solid var(--c-cyan); color: var(--c-cyan);">üèÜ Records & Hall of Fame</button>
            <button onclick="showScreen('screen-players')" style="background:transparent; opacity:0.6;">Terug naar Spelers</button>
        </div>

        <div id="modal-options" class="modal-overlay">
            <div class="modal-content">
                <h2 id="opt-title" style="color:var(--c-cyan)">Game</h2>
                <div id="opt-desc" style="font-size:0.9rem; line-height:1.6; color:#ddd; margin:15px 0; text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;"></div>
                <div class="option-grid">
                    <button class="option-btn btn-green" onclick="launchGame()">
                        <span class="option-icon">üéØ</span> SPELEN
                    </button>
                    <button class="option-btn btn-yellow" onclick="launchStats()">
                        <span class="option-icon">üìà</span> STATS
                    </button>
                </div>
                <button onclick="closeModal('modal-options')" style="margin-top:20px; background:transparent; border:1px solid #555;">Annuleren</button>
            </div>
        </div>

        <div id="screen-doubles-setup" class="screen card">
            <h2>Doubles Mode</h2>
            <p class="instruction-text">Kies de volgorde van de doelen</p>
            <div class="option-grid">
                <button onclick="startDoublesGame('clock')" class="option-btn btn-cyan">
                    <span class="option-icon">‚è∞</span> 1 - 20
                </button>
                <button onclick="startDoublesGame('random')" class="option-btn btn-purple">
                    <span class="option-icon">üîÄ</span> Random
                </button>
            </div>
            <button onclick="showScreen('screen-menu')" style="margin-top:20px;">Terug</button>
        </div>

        <div id="screen-singles-setup" class="screen card">
            <h2>Singles Mode</h2>
            <p class="instruction-text">Kies de volgorde van de doelen</p>
            <div class="option-grid">
                <button onclick="startSinglesGame('clock')" class="option-btn btn-cyan">
                    <span class="option-icon">‚è∞</span> 1 - 20
                </button>
                <button onclick="startSinglesGame('random')" class="option-btn btn-purple">
                    <span class="option-icon">üîÄ</span> Random
                </button>
            </div>
            <button onclick="showScreen('screen-menu')" style="margin-top:20px;">Terug</button>
        </div>

        <div id="screen-100-setup" class="screen card">
            <h2>100 Pijlen</h2>
            <div class="option-grid">
                <button onclick="start100Game('high')" class="option-btn btn-yellow">
                    <span class="option-icon">‚¨ÜÔ∏è</span> Hoogste
                </button>
                <button onclick="start100Game('low')" class="option-btn btn-pink">
                    <span class="option-icon">‚¨áÔ∏è</span> Laagste
                </button>
            </div>
            <button onclick="showScreen('screen-menu')" style="margin-top:20px;">Terug</button>
        </div>

        <div id="screen-checkout-setup" class="screen card">
            <h2>Checkout</h2>
            <label>Range:</label>
            <div style="display:flex; gap:10px; margin: 15px 0;">
                <input type="number" id="co-min" value="60">
                <input type="number" id="co-max" value="100">
            </div>
            <button class="btn-purple" onclick="startCheckoutGame()" style="margin-top:10px;">Start Challenge</button>
            <button onclick="showScreen('screen-menu')" style="background:transparent;">Annuleren</button>
        </div>

        <div id="modal-stats" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px;">
                <h2 id="stats-modal-title" style="color:var(--c-yellow)">Stats</h2>
                <select id="stats-modal-player" onchange="refreshGameStats()" style="width:100%; padding:15px; border-radius:15px; margin-bottom:10px; background:rgba(0,0,0,0.5); color:white; border:1px solid var(--c-cyan);"></select>
                <div id="stats-text-summary" style="margin-bottom:15px; font-size:0.9rem; opacity:0.8;"></div>
                <div class="chart-container"><canvas id="gameChart"></canvas></div>
                <button onclick="closeModal('modal-stats')" style="margin-top:20px; background:var(--btn-bg);">Sluiten</button>
            </div>
        </div>

        <div id="modal-summary" class="modal-overlay">
            <div class="modal-content">
                <h2 id="sum-title" style="color:var(--c-green); margin:0;">GAME OVER</h2>
                <div id="sum-player" style="color:#aaa; margin-bottom:10px;">Speler</div>
                
                <div id="sum-score" class="summary-score">0</div>
                
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="sb-label">Vorig Record</div>
                        <div class="sb-val" id="sum-pb">-</div>
                    </div>
                    <div class="summary-box">
                        <div class="sb-label">Verschil</div>
                        <div class="sb-val" id="sum-diff">-</div>
                    </div>
                </div>
                
                <div id="sum-msg" style="color:var(--c-pink); font-weight:bold; margin-bottom:20px;"></div>

                <button class="btn-cyan" onclick="closeModal('modal-summary'); /* stays on screen */">SPEEL OPNIEUW ‚Üª</button>
                <button onclick="closeModal('modal-summary'); showScreen('screen-menu');" style="background:transparent; border:1px solid #555;">MENU üè†</button>
            </div>
        </div>

        <div id="screen-records" class="screen card">
            <h2>üèÜ Hall of Fame</h2>
            <div id="records-content"></div>
            <button onclick="showScreen('screen-menu')" style="margin-top:20px;">Terug</button>
        </div>

        <div id="screen-game-doubles" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>Doubles</h3>
            <div class="instruction-text" id="doubles-instruction">Gooi 3 pijlen naar...</div>
            <div id="doubles-scoreboard" class="scoreboard"></div>
            <p style="text-align:center;">Pijlen: <strong id="doubles-darts-count" style="color:var(--c-cyan)">0</strong></p>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                <button class="btn-cyan" onclick="handleDoublesInput(1)">1</button>
                <button class="btn-cyan" onclick="handleDoublesInput(2)">2</button>
                <button class="btn-cyan" onclick="handleDoublesInput(3)">3</button>
            </div>
            <button class="btn-pink" onclick="handleDoublesMiss()">Mis (0)</button>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-singles" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>Singles</h3>
            <div class="instruction-text" id="singles-instruction">Gooi 3 pijlen naar...</div>
            <div id="singles-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; margin-bottom:15px;">Hits (3 pijlen):</div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                <button class="btn-pink" onclick="handleSinglesInput(0)">0</button>
                <button class="btn-cyan" onclick="handleSinglesInput(1)">1</button>
                <button class="btn-cyan" onclick="handleSinglesInput(2)">2</button>
                <button class="btn-cyan" onclick="handleSinglesInput(3)">3</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-bobs27" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>Bob's 27</h3>
            <div class="instruction-text" id="bobs-instruction">Target: D1</div>
            <div id="bobs-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; margin-bottom:15px;">Aantal keer geraakt:</div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                <button class="btn-pink" onclick="handleBobsInput(0)">0 (Mis)</button>
                <button class="btn-cyan" onclick="handleBobsInput(1)">1</button>
                <button class="btn-cyan" onclick="handleBobsInput(2)">2</button>
                <button class="btn-cyan" onclick="handleBobsInput(3)">3</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-x01" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>X01 Match</h3>
            <div class="instruction-text">Gooi de score naar 0 (Dubbel Uit)</div>
            <div id="x01-scoreboard" class="scoreboard"></div>
            <div id="x01-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--c-pink)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submitX01()" class="btn-cyan">OK</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-checkout" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>Checkout Challenge</h3>
            <div class="instruction-text">Gooi dit getal uit binnen 2 beurten (6 pijlen)</div>
            <div id="checkout-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; font-size:5rem; font-weight:900; color:var(--c-yellow);" id="co-target">?</div>
            <div id="checkout-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--c-pink)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submitCheckout()" class="btn-cyan">OK</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-100" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>100 Pijlen</h3>
            <div class="instruction-text">Gooi 100 pijlen en haal de beste score</div>
            <div id="100-scoreboard" class="scoreboard"></div>
            <div style="text-align:center;">Pijl <span id="100-counter" style="color:var(--c-yellow);">0</span>/100</div>
            <div id="100-display" class="score-display-box">0</div>
            <div class="keypad">
                <button onclick="kp(7)">7</button><button onclick="kp(8)">8</button><button onclick="kp(9)">9</button>
                <button onclick="kp(4)">4</button><button onclick="kp(5)">5</button><button onclick="kp(6)">6</button>
                <button onclick="kp(1)">1</button><button onclick="kp(2)">2</button><button onclick="kp(3)">3</button>
                <button onclick="kp('BACK')" style="color:var(--c-pink)">‚å´</button>
                <button onclick="kp(0)">0</button>
                <button onclick="submit100()" class="btn-yellow">OK</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div id="screen-game-bullstreak" class="screen card">
            <button class="btn-undo" onclick="undoLastMove()">‚Ü©</button>
            <h3>Bullstreak</h3>
            <div class="instruction-text">Blijf gooien zolang je minstens 1 bull raakt</div>
            <div id="bull-scoreboard" class="scoreboard"></div>
            <div style="text-align:center; margin:20px 0;">
                <div style="font-size:0.9rem;">HUIDIGE STREAK</div>
                <div id="bull-streak-val" style="font-size:7rem; font-weight:900; color:var(--c-pink);">0</div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="btn-cyan" style="height:80px;" onclick="handleBullResult(true)">RAAK</button>
                <button class="btn-pink" style="height:80px;" onclick="handleBullResult(false)">MIS</button>
            </div>
            <button onclick="quitGame()" style="margin-top:20px; background:transparent;">Stoppen</button>
        </div>

        <div style="margin-top: 50px; text-align: center; opacity: 0.3;">
            <button onclick="hardReset()" style="background:transparent; border:1px solid #555; width:auto; font-size:0.7rem;">‚ö†Ô∏è Reset App</button>
        </div>

    </div>

    <script>
        // --- DATA & CONFIG ---
        const KEY_PLAYERS = 'dartsPlayers';
        const KEY_HISTORY = 'dartsHistoryV3';
        
        let allPlayers = safeLoad(KEY_PLAYERS);
        let history = safeLoad(KEY_HISTORY);
        let activePlayers = [], curPIdx = 0, gameMode = '', keypadInput = "";
        let selectedGameType = ""; 
        let myChart = null;

        // UITGEBREIDE UITLEG PER SPEL (MET HTML OPMAAK VOOR DUIDELIJKHEID)
        const desc = {
            doubles: "<b>DOEL:</b> Gooi alle dubbels uit (1-20 + Bull) met zo min mogelijk pijlen.<br><br><b>HOE:</b> Je begint bij D1 (of Random). Je mag 3 pijlen gooien. Raak je? Klik op 1, 2 of 3. Mis je? Klik op 'Mis'. Je gaat door tot de Bull.",
            singles: "<b>DOEL:</b> Train je precisie. Haal een zo hoog mogelijk percentage op de enkele getallen.<br><br><b>HOE:</b> De app geeft een getal. Gooi 3 pijlen. Geef aan hoeveel er in het juiste vak zaten (single, double of triple telt allemaal als raak).",
            bobs: "<b>DOEL:</b> Eindig met een zo hoog mogelijke score en zak niet onder 0.<br><br><b>HOE:</b> Je start met 27 punten. Gooi op volgorde (D1 t/m D20, Bull).<br>Raak = waarde erbij.<br>Mis (alle 3) = waarde eraf.",
            x01: "<b>DOEL:</b> Win de wedstrijd door als eerste het aantal legs te pakken.<br><br><b>HOE:</b> Klassiek 501/301. Gooi punten weg tot exact 0. Eindigen moet met een dubbel.",
            checkout: "<b>DOEL:</b> Train je finishes. Haal 10 finishes.<br><br><b>HOE:</b> Je krijgt een random getal (bv. 82). Je hebt 6 pijlen (2 beurten) om uit te gooien. Lukt het niet? Dan heb je gefaald.",
            p100: "<b>DOEL:</b> Zet een topscore neer in 100 worpen.<br><br><b>HOE:</b> Kies 'Hoog' (bvb Triple 20 trainen) of 'Laag' (bvb T1 trainen). Gooi 100 pijlen en voer telkens je score in.",
            bull: "<b>DOEL:</b> Een zo lang mogelijke reeks (streak) neerzetten.<br><br><b>HOE:</b> Gooi 3 pijlen per beurt. Je MOET minstens √©√©n Bull (groen of rood) raken om in het spel te blijven."
        };

        // Game States
        let doublesState = {}, singlesState = {}, x01State = {}, checkoutState = {}, state100 = {}, stateBull = {}, bobsState = {};
        const standardTargets = [...Array(20).keys()].map(i=>i+1).concat([25]); // 1 to 20 + Bull
        const boardOrder = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5, 25]; // Traditional board order (not strictly needed if using clock/random, but good for reference)
        
        // UNDO SYSTEM VARS
        let undoStack = []; // Stores previous state

        // STARTUP
        window.onload = function() {
            renderPlayerList();
            const inp = document.getElementById('new-player-name');
            if(inp) inp.addEventListener("keypress", function(e) { if(e.key==="Enter") handleAddPlayer(); });
        };

        // --- CORE FUNCTIONS ---
        const sfx = { win: () => { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const osc = ctx.createOscillator(); osc.type='triangle'; osc.frequency.value=600; osc.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime+0.1); } catch(e){} } };
        function triggerConfetti() { try { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00f3ff', '#ff00aa', '#ffee00'] }); } catch(e){} }
        function safeLoad(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch(e){ return []; } }

        function renderPlayerList() {
            const l = document.getElementById('player-list');
            if(!l) return; l.innerHTML = "";
            if(allPlayers.length === 0) { l.innerHTML = "<p style='text-align:center;opacity:0.5'>Nog geen spelers.</p>"; return; }
            allPlayers.forEach(n => {
                l.innerHTML += `<div class="player-row"><div style="display:flex;align-items:center;"><input type="checkbox" class="player-select-checkbox cb" value="${n}"><span style="font-weight:bold;font-size:1.1rem;color:var(--c-cyan)">${n}</span></div><button class="btn-delete" onclick="handleDeletePlayer('${n}')">‚úï</button></div>`;
            });
        }

        function handleAddPlayer() {
            const input = document.getElementById('new-player-name');
            const name = input.value.trim().toUpperCase();
            if(name && !allPlayers.includes(name)) {
                allPlayers.push(name);
                localStorage.setItem(KEY_PLAYERS, JSON.stringify(allPlayers));
                renderPlayerList();
            }
            input.value = ""; input.focus();
        }

        function handleDeletePlayer(name) {
            if(confirm("Verwijder " + name + "?")) {
                allPlayers = allPlayers.filter(p => p !== name);
                localStorage.setItem(KEY_PLAYERS, JSON.stringify(allPlayers));
                renderPlayerList();
            }
        }

        function confirmPlayers() {
            activePlayers = Array.from(document.querySelectorAll('.cb:checked')).map(c=>c.value);
            if(!activePlayers.length) return alert("Kies speler(s)");
            document.getElementById('active-players-display').innerText = activePlayers.join(", ");
            showScreen('screen-menu');
        }

        // --- MENU & MODALS ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-players') renderPlayerList();
        }

        function openGameMenu(type, title, description) {
            selectedGameType = type;
            document.getElementById('opt-title').innerText = title;
            document.getElementById('opt-desc').innerHTML = description; // InnerHTML voor <br> support
            const modal = document.getElementById('modal-options');
            modal.style.display = 'flex'; setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 300);
        }

        function launchGame() {
            closeModal('modal-options');
            const t = selectedGameType;
            if(t === 'doubles') showScreen('screen-doubles-setup');
            else if(t === 'singles') showScreen('screen-singles-setup');
            else if(t === 'bobs27') setupBobs27();
            else if(t === 'x01') setupX01();
            else if(t === 'checkout') setupCheckoutMenu();
            else if(t === '100') setup100Menu();
            else if(t === 'bull') setupBullstreak();
        }

        function launchStats() {
            closeModal('modal-options');
            const s = document.getElementById('stats-modal-player');
            s.innerHTML = "";
            if(allPlayers.length === 0) s.innerHTML = "<option>Geen spelers</option>";
            else allPlayers.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`);
            
            document.getElementById('stats-modal-title').innerText = document.getElementById('opt-title').innerText + " Stats";
            const m = document.getElementById('modal-stats');
            m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10);
            refreshGameStats();
        }

        function showSummary(player, score, gameType, metric='max') {
            document.getElementById('sum-player').innerText = player;
            document.getElementById('sum-score').innerText = score;
            
            let dbType = gameType;
            if(gameType === '100') dbType = '100high'; 
            
            const recs = history.filter(h => h.player === player && h.gameType === dbType).map(r => {
                let val = r.result.score || r.result; 
                if(typeof r.result === 'object' && r.result.darts) val = r.result.darts;
                return parseInt(val);
            });
            recs.pop(); 
            
            let oldBest = "-";
            let msg = "";
            let diff = "-";

            if(recs.length > 0) {
                oldBest = metric==='max' ? Math.max(...recs) : Math.min(...recs);
                const current = parseInt(score);
                if ((metric==='max' && current > oldBest) || (metric==='min' && current < oldBest)) {
                    msg = "üéâ NIEUW RECORD! üéâ";
                    diff = "Verbeterd!";
                    sfx.win(); triggerConfetti();
                } else {
                    let delta = current - oldBest;
                    diff = (delta > 0 ? "+" : "") + delta;
                    msg = "Goed gespeeld!";
                }
            } else {
                msg = "Eerste spel!";
            }

            document.getElementById('sum-pb').innerText = oldBest;
            document.getElementById('sum-diff').innerText = diff;
            document.getElementById('sum-msg').innerText = msg;

            const modal = document.getElementById('modal-summary');
            modal.style.display = 'flex'; setTimeout(() => modal.classList.add('show'), 10);
        }

        // --- STATS LOGIC FOR MODAL ---
        function refreshGameStats() {
            const player = document.getElementById('stats-modal-player').value;
            let type = selectedGameType;
            let dbType = type;
            if(type === '100') dbType = '100high';
            if(type === 'bull') dbType = 'bullstreak';
            if(type === 'x01') dbType = 'x01_throw';
            if(type === 'checkout') dbType = 'checkout_wins';

            const recs = history.filter(h => h.player === player && h.gameType === dbType).sort((a,b) => new Date(a.date) - new Date(b.date));
            const labels = recs.map(r => new Date(r.date).toLocaleDateString());
            let dataPoints = [];
            let summary = "Geen data.";

            if(recs.length > 0) {
                dataPoints = recs.map(r => {
                    let val = r.result.score || r.result;
                    if(typeof r.result === 'object' && r.result.darts) val = r.result.darts; 
                    return parseInt(val) || 0;
                }).filter(n => n > 0);

                const best = Math.max(...dataPoints);
                const avg = (dataPoints.reduce((a,b)=>a+b,0) / dataPoints.length).toFixed(1);
                summary = `Beste: <strong>${best}</strong> | Gemiddeld: <strong>${avg}</strong>`;
            }
            
            document.getElementById('stats-text-summary').innerHTML = summary;

            const ctx = document.getElementById('gameChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Score', data: dataPoints, borderColor: '#00f3ff', backgroundColor: 'rgba(0,243,255,0.1)', tension: 0.3, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#aaa' } } } }
            });
        }

        // --- RECORDS SCREEN ---
        function showRecords() {
            const div = document.getElementById('records-content');
            div.innerHTML = "";
            if(allPlayers.length === 0) { div.innerHTML = "Geen spelers."; return; }

            const getGlobalBest = (type, mode='max') => {
                let bestVal = mode==='min' ? 9999 : -9999;
                let bestPlayer = "-";
                allPlayers.forEach(p => {
                    const rs = history.filter(h => h.player === p && h.gameType === type).map(r => parseInt(r.result.score || r.result));
                    if(rs.length > 0) {
                        const pBest = mode==='min' ? Math.min(...rs) : Math.max(...rs);
                        if(mode==='max' && pBest > bestVal) { bestVal = pBest; bestPlayer = p; }
                        if(mode==='min' && pBest < bestVal) { bestVal = pBest; bestPlayer = p; }
                    }
                });
                return bestPlayer === "-" ? "-" : `${bestVal} (${bestPlayer})`;
            };

            const recs = [
                {t: '100high', l: '100 Pijlen (High)', c: 'var(--c-yellow)'},
                {t: '100low', l: '100 Pijlen (Low)', c: 'var(--c-pink)', m: 'min'},
                {t: 'bullstreak', l: 'Bullstreak', c: 'var(--c-cyan)'},
                {t: 'bobs27', l: 'Bob\'s 27', c: 'var(--c-green)'}
            ];

            recs.forEach(r => {
                div.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:10px;">
                    <h3 style="color:${r.c}">${r.l}</h3>
                    <div style="font-size:1.5rem; font-weight:bold;">${getGlobalBest(r.t, r.m || 'max')}</div>
                </div>`;
            });
            showScreen('screen-records');
        }

        // --- GAME LOGIC ---
        function saveRec(type, player, res) {
            history.push({ date: new Date().toISOString(), gameType: type, player: player, result: res });
            localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
        }
        function quitGame() { if(confirm("Stoppen?")) showScreen('screen-menu'); }
        function hardReset() { if(confirm("ALLES WISSEN?")) { localStorage.clear(); location.reload(); } }
        function kp(v) {
            if (v==='BACK') keypadInput = keypadInput.slice(0,-1); else if (keypadInput.length < 3) keypadInput += v;
            ['x01-display', 'checkout-display', '100-display'].forEach(id => { const el = document.getElementById(id); if(el && el.closest('.active')) el.innerText = keypadInput || "0"; });
        }
        function nextTurn() { curPIdx = (curPIdx + 1) % activePlayers.length; }

        // UNDO FUNCTIONALITY
        function snapshotState() {
            let stateToSave = {
                gameMode: gameMode,
                curPIdx: curPIdx,
                keypadInput: keypadInput,
                doublesState: JSON.parse(JSON.stringify(doublesState)),
                singlesState: JSON.parse(JSON.stringify(singlesState)),
                x01State: JSON.parse(JSON.stringify(x01State)),
                checkoutState: JSON.parse(JSON.stringify(checkoutState)),
                state100: JSON.parse(JSON.stringify(state100)),
                stateBull: JSON.parse(JSON.stringify(stateBull)),
                bobsState: JSON.parse(JSON.stringify(bobsState)),
                historyLen: history.length
            };
            undoStack.push(stateToSave);
            if(undoStack.length > 5) undoStack.shift();
        }

        function undoLastMove() {
            if(undoStack.length === 0) return alert("Kan niet verder terug.");
            const s = undoStack.pop();
            
            gameMode = s.gameMode;
            curPIdx = s.curPIdx;
            keypadInput = s.keypadInput;
            doublesState = s.doublesState;
            singlesState = s.singlesState;
            x01State = s.x01State;
            checkoutState = s.checkoutState;
            state100 = s.state100;
            stateBull = s.stateBull;
            bobsState = s.bobsState;

            if(history.length > s.historyLen) {
                history = history.slice(0, s.historyLen);
                localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
            }

            if(gameMode==='doubles') updateDoublesUI();
            if(gameMode==='singles') updateSinglesUI();
            if(gameMode==='x01') updateX01UI();
            if(gameMode==='checkout') updateCheckoutUI();
            if(gameMode==='100') update100UI();
            if(gameMode==='bull') updateBullUI();
            if(gameMode==='bobs') updateBobsUI();
            
            ['x01-display', 'checkout-display', '100-display'].forEach(id => { const el = document.getElementById(id); if(el) el.innerText = keypadInput || "0"; });
        }

        // DOUBLES
        function startDoublesGame(mode) {
            undoStack = [];
            activePlayers.forEach(p => {
                // Determine order
                let queue = [...standardTargets]; // 1-20+Bull
                if (mode === 'random') queue.sort(() => Math.random() - 0.5);
                doublesState[p] = { idx:0, curDarts:0, queue: queue };
            });
            gameMode='doubles'; curPIdx=0; updateDoublesUI(); showScreen('screen-game-doubles'); 
        }
        function updateDoublesUI() {
            const sb=document.getElementById('doubles-scoreboard'); sb.innerHTML='';
            const p = activePlayers[curPIdx], s = doublesState[p];
            const targetVal = s.queue[s.idx];
            const target = s.idx >= s.queue.length ? "WIN" : (targetVal === 25 ? "BULL" : "D" + targetVal);
            document.getElementById('doubles-instruction').innerText = `Doel: ${target}`;
            activePlayers.forEach((p,i) => {
                const s=doublesState[p]; 
                const tv = s.queue[s.idx];
                const txt=s.idx>=s.queue.length?"WIN":(tv===25?"BULL":"D"+tv);
                sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${txt}</div></div>`;
            });
            document.getElementById('doubles-darts-count').innerText=doublesState[activePlayers[curPIdx]].curDarts;
        }
        function handleDoublesInput(d) {
            snapshotState();
            const p=activePlayers[curPIdx],s=doublesState[p]; 
            saveRec('doubles',p,{target:s.queue[s.idx],darts:s.curDarts+d});
            s.idx++; s.curDarts=0; if(s.idx>=s.queue.length){ showSummary(p, "Voltooid!", 'doubles'); return; }
            nextTurn(); updateDoublesUI();
        }
        function handleDoublesMiss() { snapshotState(); doublesState[activePlayers[curPIdx]].curDarts+=3; nextTurn(); updateDoublesUI(); }

        // SINGLES
        function startSinglesGame(mode) { 
            undoStack=[]; gameMode='singles'; 
            activePlayers.forEach(p=> {
                let queue = [...standardTargets]; // 1-20+Bull
                if (mode === 'random') queue.sort(() => Math.random() - 0.5);
                // We use 'queue' similar to doubles, but for singles we just need to know the current target.
                // However, previous Logic used random sorting EVERY turn for singles.
                // Let's adopt the 'Random' vs 'Clock' logic here too.
                // If random, we create a shuffled queue. If clock, ordered queue.
                // BUT: Singles usually implies random popups in training apps.
                // Let's stick to the Queue system for consistency.
                singlesState[p]={ queue: queue, idx:0, score:0 };
            });
            curPIdx=0; updateSinglesUI(); showScreen('screen-game-singles'); 
        }
        function updateSinglesUI() {
            const sb=document.getElementById('singles-scoreboard'); sb.innerHTML='';
            const p = activePlayers[curPIdx], s = singlesState[p];
            const tVal = s.queue[s.idx];
            const target = s.idx >= s.queue.length ? "KLAAR" : (tVal===25?'BULL':tVal);
            document.getElementById('singles-instruction').innerText = `Doel: ${target}`;
            activePlayers.forEach((p,i)=>{
                const s=singlesState[p]; 
                const tv = s.queue[s.idx];
                const txt = s.idx>=s.queue.length?"FIN":(tv===25?'BULL':tv);
                sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${txt}</div><div style="font-size:0.8rem">Hits: ${s.score}</div></div>`;
            });
            if(singlesState[activePlayers[curPIdx]].idx>=singlesState[activePlayers[curPIdx]].queue.length) { saveRec('singles',activePlayers[curPIdx],singlesState[activePlayers[curPIdx]].score); showSummary(activePlayers[curPIdx], singlesState[activePlayers[curPIdx]].score, 'singles'); }
        }
        function handleSinglesInput(h) { 
            snapshotState();
            const p = activePlayers[curPIdx]; 
            saveRec('singles_stat', p, {target:singlesState[p].queue[singlesState[p].idx], hits:h});
            singlesState[p].score+=h; singlesState[p].idx++; nextTurn(); updateSinglesUI(); 
        }

        // BOBS 27
        function setupBobs27() { undoStack=[]; gameMode='bobs'; activePlayers.forEach(p => bobsState[p] = {score: 27, idx: 0, alive: true}); curPIdx = 0; updateBobsUI(); showScreen('screen-game-bobs27'); }
        function updateBobsUI() {
            const sb = document.getElementById('bobs-scoreboard'); sb.innerHTML = '';
            const p = activePlayers[curPIdx];
            let attempts = 0;
            while(!bobsState[p].alive && attempts < activePlayers.length) { curPIdx = (curPIdx + 1) % activePlayers.length; attempts++; }
            if(attempts >= activePlayers.length) { alert("Game Over!"); showScreen('screen-menu'); return; }
            const s = bobsState[activePlayers[curPIdx]];
            const tVal = bobsTargets[s.idx]; const tTxt = tVal === 25 ? "BULL" : "D" + tVal;
            document.getElementById('bobs-instruction').innerText = `Target: ${tTxt}`;
            activePlayers.forEach((pl, i) => {
                const st = bobsState[pl]; const cls = !st.alive ? 'opacity:0.3' : (i===curPIdx?'active-turn':'');
                sb.innerHTML += `<div class="p-card ${cls}"><div class="p-name">${pl}</div><div class="p-score">${st.score}</div></div>`;
            });
        }
        function handleBobsInput(hits) {
            snapshotState();
            const p = activePlayers[curPIdx], s = bobsState[p];
            const targetVal = bobsTargets[s.idx] === 25 ? 25 : bobsTargets[s.idx]; const points = targetVal * 2;
            if(hits > 0) s.score += (points * hits); else { s.score -= points; document.getElementById('screen-game-bobs27').classList.add('flash-red'); setTimeout(()=>document.getElementById('screen-game-bobs27').classList.remove('flash-red'), 500); }
            if(s.score < 0) { s.alive = false; alert(`${p} is AF!`); } 
            else if(s.idx >= bobsTargets.length - 1) { saveRec('bobs27', p, s.score); showSummary(p, s.score, 'bobs27'); return; } 
            else s.idx++;
            nextTurn(); updateBobsUI();
        }

        // X01
        function setupX01() { undoStack=[]; gameMode='x01'; let l=parseInt(prompt("Legs?","1"))||1; let st=parseInt(prompt("Start?","501"))||501; activePlayers.forEach(p=>x01State[p]={score:st,start:st,legs:0,req:l}); curPIdx=0; keypadInput=""; updateX01UI(); showScreen('screen-game-x01'); }
        function updateX01UI() {
            const sb=document.getElementById('x01-scoreboard'); sb.innerHTML='';
            activePlayers.forEach((p,i)=>{ sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${x01State[p].score}</div><div class="leg-indicator">L:${x01State[p].legs}</div></div>`; });
            document.getElementById('x01-display').innerText=keypadInput||"0";
        }
        function submitX01() {
            const v=parseInt(keypadInput); if(isNaN(v)||v>180) return alert("Fout");
            snapshotState();
            const p=activePlayers[curPIdx], s=x01State[p], r=s.score-v; saveRec('x01_throw',p,v);
            if(r===0){ s.legs++; if(s.legs>=s.req){ showSummary(p, s.legs + " LEGS", 'x01'); return; }else{alert("Leg win!"); activePlayers.forEach(pl=>x01State[pl].score=x01State[pl].start);} }
            else if(r<=1) alert("BUST"); else s.score=r;
            keypadInput=""; nextTurn(); updateX01UI();
        }

        // Checkout
        function setupCheckoutMenu() { showScreen('screen-checkout-setup'); }
        function startCheckoutGame() {
            let mn=parseInt(document.getElementById('co-min').value), mx=parseInt(document.getElementById('co-max').value);
            undoStack=[]; gameMode='checkout'; activePlayers.forEach(p=>checkoutState[p]={r:1,wins:0,t:Math.floor(Math.random()*(mx-mn+1)+mn),cur:0,tr:0,mn:mn,mx:mx}); activePlayers.forEach(p=>checkoutState[p].cur=checkoutState[p].t); curPIdx=0; updateCheckoutUI(); showScreen('screen-game-checkout');
        }
        function updateCheckoutUI() {
            const p=activePlayers[curPIdx], s=checkoutState[p]; if(s.r>10) { saveRec('checkout_wins',p,s.wins); showSummary(p, s.wins + "/10", 'checkout_wins'); return; }
            const sb=document.getElementById('checkout-scoreboard'); sb.innerHTML='';
            activePlayers.forEach((pl,i)=>{ sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${pl}</div><div class="p-score">${checkoutState[pl].wins}/10</div></div>`; });
            document.getElementById('co-target').innerText=s.cur; document.getElementById('checkout-display').innerText=keypadInput||"0";
        }
        function submitCheckout() {
            const v=parseInt(keypadInput); if(isNaN(v)) return;
            snapshotState();
            const p=activePlayers[curPIdx], s=checkoutState[p], r=s.cur-v;
            if(r===0){ s.wins++; nextCO(s); } else if(r<=1){ s.tr++; checkFailCO(s); } else { s.cur=r; s.tr++; checkFailCO(s); }
            keypadInput=""; if(s.cur>0) nextTurn(); updateCheckoutUI();
        }
        function checkFailCO(s) { if(s.tr>=2 && s.cur>0) nextCO(s); }
        function nextCO(s) { s.r++; s.tr=0; s.t=Math.floor(Math.random()*(s.mx-s.mn+1)+s.mn); s.cur=s.t; }

        // 100
        let mode100='high';
        function setup100Menu(){ showScreen('screen-100-setup'); }
        function start100Game(m){ undoStack=[]; mode100=m; gameMode='100'; activePlayers.forEach(p=>state100[p]={score:0,darts:0}); curPIdx=0; update100UI(); showScreen('screen-game-100'); }
        function update100UI(){
            const sb=document.getElementById('100-scoreboard'); sb.innerHTML='';
            activePlayers.forEach((p,i)=>{ sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''}"><div class="p-name">${p}</div><div class="p-score">${state100[p].score}</div></div>`; });
            document.getElementById('100-counter').innerText=state100[activePlayers[curPIdx]].darts; document.getElementById('100-display').innerText=keypadInput||"0";
        }
        function submit100(){
            const v=parseInt(keypadInput); if(isNaN(v)||v>180) return;
            snapshotState();
            const p=activePlayers[curPIdx], s=state100[p];
            let dTurn = (100-s.darts===1)?1:3; if(dTurn===1&&v>60) return alert("Max 60");
            s.score+=v; s.darts+=dTurn; keypadInput="";
            if(s.darts>=100){ 
                const type = mode100==='high'?'100high':'100low';
                saveRec(type,p,s.score); showSummary(p, s.score, type, mode100==='high'?'max':'min'); 
                if(curPIdx===activePlayers.length-1) return;
            }
            nextTurn(); update100UI();
        }

        // Bull
        function setupBullstreak(){ undoStack=[]; gameMode='bull'; activePlayers.forEach(p=>stateBull[p]={streak:0,alive:true}); curPIdx=0; updateBullUI(); showScreen('screen-game-bullstreak'); }
        function updateBullUI(){
            let att=0; while(!stateBull[activePlayers[curPIdx]].alive && att<activePlayers.length){ curPIdx=(curPIdx+1)%activePlayers.length; att++; }
            if(att>=activePlayers.length){ showScreen('screen-menu'); return; }
            const sb=document.getElementById('bull-scoreboard'); sb.innerHTML='';
            activePlayers.forEach((p,i)=>{ sb.innerHTML+=`<div class="p-card ${i===curPIdx?'active-turn':''} ${!stateBull[p].alive?'opacity:0.3':''}"><div class="p-name">${p}</div><div class="p-score">${stateBull[p].streak}</div></div>`; });
            document.getElementById('bull-streak-val').innerText=stateBull[activePlayers[curPIdx]].streak;
        }
        function handleBullResult(h){
            snapshotState();
            const p=activePlayers[curPIdx]; if(h) stateBull[p].streak++; else { 
                saveRec('bullstreak',p,stateBull[p].streak); stateBull[p].alive=false; 
                showSummary(p, stateBull[p].streak + " Beurten", 'bullstreak');
            }
            curPIdx=(curPIdx+1)%activePlayers.length; updateBullUI();
        }

    </script>
</body>
</html>
